<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Job Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #2f2f2f;
            color: #ffffff;
        }

        /* Custom container and theme background */
        .container-fluid {
            width: 100%;
            height: 100%;
            background-image: repeating-radial-gradient(#0c0a0a 80%, #2f312f 90%, #3f4549 90%);
            background-size: 65px 65px;
            padding: 40px;
        }

        /* Custom card-like container for login-form style */
        .login-container {
            background-color: #2f2f2f;
            border-radius: 8px;
            box-shadow: rgb(31 31 31 / 17%) 0px -23px 25px 0px inset,
                        rgb(108 108 108 / 23%) 0px -36px 30px 0px inset,
                        rgba(0, 0, 0, 0.1) 0px -79px 40px 0px inset,
                        rgba(0, 0, 0, 0.06) 0px 2px 1px,
                        rgba(0, 0, 0, 0.09) 0px 4px 2px,
                        rgba(0, 0, 0, 0.09) 0px 8px 4px,
                        rgba(0, 0, 0, 0.09) 0px 16px 8px,
                        rgba(0, 0, 0, 0.09) 0px 32px 16px;
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        .heading {
            color: #ffffff;
            font-weight: 500;
            font-size: 40px;
            margin-bottom: 5px;
        }

        /* Styling DataTables */
        .dataTables_wrapper {
            background-color: #2f2f2f;
            color: #ffffff;
        }

        table.dataTable {
            border-color: #0173ed;
        }

        table.dataTable thead th {
            background-color: #202c3e;
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
        }

        table.dataTable tbody tr {
            background-color: #353535;
            color: #ffffff;
        }

        table.dataTable tbody tr:hover {
            background-color: #202c3e;
            color: #ffffff;
        }

        /* Custom styling for the map container */
        .map-container {
            height: 500px;
            margin-bottom: 20px;
            background-color: #353535;
            border-radius: 8px;
            box-shadow: rgb(31 31 31 / 17%) 0px -23px 25px 0px inset,
                        rgb(108 108 108 / 23%) 0px -36px 30px 0px inset,
                        rgba(0, 0, 0, 0.1) 0px -79px 40px 0px inset;
        }

        /* Responsive map */
        @media (max-width: 768px) {
            .map-container {
                height: 300px;
            }
        }

        @media (max-width: 576px) {
            .map-container {
                height: 250px;
            }
        }

        /* Ensure InfoWindow text is visible */
        .info-window-content {
            color: #000000; /* Black text color for InfoWindow */
        }

    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="login-container">
            <h1 class="heading">Monitor-Censo-Campo</h1>

            <div class="row">
                <div class="col-lg-12">
                    <div id="map" class="map-container"></div>
                </div>
            </div>

            <!-- Navigation for buckets -->
            <ul class="nav nav-pills my-4" id="bucketTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="cam1-tab" data-toggle="pill" href="#cam1" role="tab">CAM1</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cam2-tab" data-toggle="pill" href="#cam2" role="tab">CAM2</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cam3-tab" data-toggle="pill" href="#cam3" role="tab">CAM3</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cam4-tab" data-toggle="pill" href="#cam4" role="tab">CAM4</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="cam5-tab" data-toggle="pill" href="#cam5" role="tab">CAM5</a>
                </li>
            </ul>

            <!-- DataTables for each CAM bucket -->
            <div class="tab-content">
                <div class="tab-pane fade show active table-section" id="cam1" role="tabpanel">
                    <table id="cam1Table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Estructura</th>
                                <th>Fecha y Hora</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>No. Sol</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="tab-pane fade table-section" id="cam2" role="tabpanel">
                    <table id="cam2Table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Estructura</th>
                                <th>Fecha y Hora</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>No. Sol</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="tab-pane fade table-section" id="cam3" role="tabpanel">
                    <table id="cam3Table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Estructura</th>
                                <th>Fecha y Hora</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>No. Sol</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="tab-pane fade table-section" id="cam4" role="tabpanel">
                    <table id="cam4Table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Estructura</th>
                                <th>Fecha y Hora</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>No. Sol</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="tab-pane fade table-section" id="cam5" role="tabpanel">
                    <table id="cam5Table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Comentario</th>
                                <th>Estructura</th>
                                <th>Fecha y Hora</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>No. Sol</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v8 (Global) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Google Maps API with async loading -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvhXkpjn3NIKaTnuL3X_W-IMty4urq2MA"></script>

    <!-- Bootstrap and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Initialization and Real-Time Data -->
    <script>
        let map;
        let bucketMarkers = {};  // To keep track of markers for each bucket

        window.onload = function() {
            // Firebase configuration
            var firebaseConfig = {
                apiKey: "AIzaSyCGuGpJEWo1_9gWwgSv3JO9s1051wDpY6E",
    authDomain: "alumbradopubliconte.firebaseapp.com",
    databaseURL: "https://alumbradopubliconte-default-rtdb.firebaseio.com",
    projectId: "alumbradopubliconte",
    storageBucket: "alumbradopubliconte.appspot.com",
    messagingSenderId: "842157703635",
    appId: "1:842157703635:web:64db480e6191f6c0326f26",
    measurementId: "G-H4PG2MM8S5"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);

            // Reference to the database
            var db = firebase.database();

            // Function to capitalize the first letter of each word
            function capitalizeWords(str) {
                return str.toLowerCase().replace(/\b\w/g, function (c) {
                    return c.toUpperCase();
                });
            }

            // Initialize Google Map with a lighter blue color
            function initMap() {
    var mapOptions = {
        center: { lat: 25.6866, lng: -100.3161 }, // Example coordinates (Monterrey)
        zoom: 12,
        styles: [
            {
                "featureType": "water",
                "elementType": "geometry",
                "stylers": [
                    { "color": "#202c3e" }  // Dark gray-blue water
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "geometry",
                "stylers": [
                    { "color": "#2f3948" }  // Dark gray for landscape
                ]
            },
            {
                "featureType": "road",
                "elementType": "geometry",
                "stylers": [
                    { "color": "#38414e" }  // Darker road colors
                ]
            },
            {
                "featureType": "poi",
                "elementType": "geometry",
                "stylers": [
                    { "color": "#283e4a" }  // Darker color for points of interest
                ]
            },
            {
                "elementType": "labels.text.fill",
                "stylers": [
                    { "color": "#ffffff" }  // White text for labels
                ]
            },
            {
                "elementType": "labels.text.stroke",
                "stylers": [
                    { "color": "#2f3948" }  // Darker text stroke
                ]
            }
        ]
    };

    map = new google.maps.Map(document.getElementById("map"), mapOptions);
}


            // Function to add data from Firebase to the table and map
            function populateTableAndMap(bucket, iconUrl) {
                const bucketRef = db.ref(bucket);
                const table = $(`#${bucket.toLowerCase()}Table`).DataTable();
                const currentMarkers = [];  // Markers for this specific bucket

                const infoWindow = new google.maps.InfoWindow();  // Create an InfoWindow

                bucketRef.on('value', (snapshot) => {
                    var data = snapshot.val();
                    table.clear(); // Clear the table before adding new data

                    // Remove existing markers for this bucket
                    if (bucketMarkers[bucket]) {
                        bucketMarkers[bucket].forEach(marker => marker.setMap(null));
                    }

                    for (var key in data) {
                        if (data.hasOwnProperty(key)) {
                            var job = data[key];

                            // Add default values if any of the fields are missing or invalid
                            var comentario = capitalizeWords(job.comentario || "N/A");
                            var estructura = capitalizeWords(job.estructura || "N/A");
                            var fecha_hora = job.fecha_hora || "N/A";
                            var latitud = (job.latitud !== "0") ? job.latitud : null;
                            var longitud = (job.longitud !== "0") ? job.longitud : null;
                            var nosol = job.nosol || "N/A";

                            // Add job data to DataTable
                            table.row.add([
                                comentario, 
                                estructura, 
                                fecha_hora, 
                                latitud || "Not available", 
                                longitud || "Not available", 
                                nosol
                            ]);

                            // Add marker to map if valid coordinates are available
                            if (latitud && longitud) {
                                var marker = new google.maps.Marker({
                                    position: { lat: parseFloat(latitud), lng: parseFloat(longitud) },
                                    map: map,
                                    title: `${bucket} - ${comentario}`,
                                    icon: {
                                        url: iconUrl,  // Use the custom icon for this bucket
                                        scaledSize: new google.maps.Size(24, 24)  // Set size to 24x24
                                    }
                                });
                                currentMarkers.push(marker);  // Keep track of markers

                                // Add click listener for InfoWindow
                                google.maps.event.addListener(marker, 'click', (function(marker, job) {
                                    return function() {
                                        // Set the content for InfoWindow with custom styles
                                        const content = `
                                            <div class="info-window-content">
                                                <strong>${capitalizeWords(bucket)}</strong><br>
                                                <strong>Comentario:</strong> ${capitalizeWords(job.comentario)}<br>
                                                <strong>Estructura:</strong> ${capitalizeWords(job.estructura)}<br>
                                                <strong>Fecha y Hora:</strong> ${job.fecha_hora}<br>
                                                <strong>No. Sol:</strong> ${job.nosol}
                                            </div>
                                        `;
                                        infoWindow.setContent(content);
                                        infoWindow.open(map, marker);  // Show InfoWindow
                                    };
                                })(marker, job));
                            }
                        }
                    }

                    // Save the current markers for this bucket
                    bucketMarkers[bucket] = currentMarkers;

                    table.draw(); // Refresh the table with new data
                });
            }

            // Call initMap after page load
            initMap();

            // Populate tables and maps for each CAM bucket with different PNG icons and sizes
            populateTableAndMap('CAM1', 'cam_blue.png');  // PNG icon for CAM1
            populateTableAndMap('CAM2', 'cam_cyan.png');  // PNG icon for CAM2
            populateTableAndMap('CAM3', 'cam_red.png');  // PNG icon for CAM3
            populateTableAndMap('CAM4', 'cam_yellow.png');  // PNG icon for CAM4
            populateTableAndMap('CAM5', 'cam_green.png');  // PNG icon for CAM5
        };
    </script>
</body>
</html>

